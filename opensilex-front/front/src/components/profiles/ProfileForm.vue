<template>
  <b-modal ref="modalRef" @ok.prevent="validate" size="xl">
    <template v-slot:modal-ok>{{$t('component.common.ok')}}</template>
    <template v-slot:modal-cancel>{{$t('component.common.cancel')}}</template>

    <template v-slot:modal-title>{{title}}</template>
    <ValidationObserver ref="validatorRef">
      <b-form>
        <!-- URI -->
        <b-form-group :label="$t('component.profile.profile-uri') + ':'" label-for="uri">
          <ValidationProvider vid="autogenerated">
            <b-form-checkbox
              v-if="!editMode"
              id="autogenerated"
              v-model="uriGenerated"
              name="autogenerated"
            >{{$t('component.common.autogenerated-uri')}}</b-form-checkbox>
          </ValidationProvider>
          <ValidationProvider
            name="uri"
            rules="required_if:autogenerated,false|url"
            v-slot="{ errors }"
          >
            <b-form-input
              id="uri"
              v-model="form.uri"
              :disabled="uriGenerated"
              type="text"
              required
              :placeholder="$t('component.common.autogenerated-uri')"
            ></b-form-input>
            <div class="error-message alert alert-danger">{{ errors[0] }}</div>
          </ValidationProvider>
        </b-form-group>
        <!-- Name -->
        <b-form-group :label="$t('component.common.name') + ':'" label-for="name" required>
          <ValidationProvider
            :name="$t('component.common.name')"
            rules="required"
            v-slot="{ errors }"
          >
            <b-form-input
              id="name"
              v-model="form.name"
              type="text"
              required
              :placeholder="$t('component.profile.form-name-placeholder')"
              autocomplete="no"
            ></b-form-input>
            <div class="error-message alert alert-danger">{{ errors[0] }}</div>
          </ValidationProvider>
        </b-form-group>
        <!-- Profiles categories -->
        <b-card no-body>
          <b-tabs pills card>
            <b-tab
              v-for="credentialsGroup in credentialsGroups"
              v-bind:key="credentialsGroup.groupId"
              v-bind:title="$t(credentialsGroup.groupKeyLabel)"
            >
            <!-- Profiles category credentials -->
              <b-form-checkbox-group
                v-bind:key="credentialsGroup.groupId"
                v-model="selectedCredentials[credentialsGroup.groupId]"
                v-bind:options="credentialOptions[credentialsGroup.groupId]"
                switches
              ></b-form-checkbox-group>
            </b-tab>
          </b-tabs>
        </b-card>
      </b-form>
    </ValidationObserver>
  </b-modal>
</template>

<script lang="ts">
import { Component, Prop } from "vue-property-decorator";
import Vue from "vue";
import VueRouter from "vue-router";
import {
  ProfileGetDTO,
  CredentialsGroupDTO,
  ProfileCreationDTO
} from "opensilex-rest/index";

@Component
export default class ProfileForm extends Vue {
  $opensilex: any;
  $store: any;
  $router: VueRouter;

  get user() {
    return this.$store.state.user;
  }

  uriGenerated = true;

  @Prop()
  credentialsGroups: any;

  private _selectedCredentials = null;

  get selectedCredentials() {
    let def: any = {};
    let credentialsGroups = this.credentialsGroups;
    for (let i = 0; i < credentialsGroups.length; i++) {
      def[credentialsGroups[i].groupId] = [];

      for (let j = 0; j < credentialsGroups[i].credentials.length; j++) {
        let credentialId = credentialsGroups[i].credentials[j].id;
        if (this.form.credentials.indexOf(credentialId) >= 0) {
          def[credentialsGroups[i].groupId].push(credentialId);
        }
      }
    }

    this._selectedCredentials = def;

    return this._selectedCredentials;
  }

  set selectedCredentials(value) {
    this._selectedCredentials = value;
  }

  get credentialOptions() {
    let credentialsGroups = this.credentialsGroups;
    let def: any = {};
    for (let i = 0; i < credentialsGroups.length; i++) {
      def[credentialsGroups[i].groupId] = [];

      for (let j = 0; j < credentialsGroups[i].credentials.length; j++) {
        let credential = credentialsGroups[i].credentials[j];
        def[credentialsGroups[i].groupId].push({
          text: this.$t(credential.label),
          value: credential.id
        });
      }
    }

    return def;
  }

  form: ProfileGetDTO = {
    uri: "",
    name: "",
    credentials: []
  };

  title = "";

  editMode = false;

  clearForm() {
    this.form = {
      uri: "",
      name: "",
      credentials: []
    };
  }

  showCreateForm() {
    this.clearForm();
    this.editMode = false;
    this.title = this.$t("component.profile.add").toString();
    this.uriGenerated = true;
    let modalRef: any = this.$refs.modalRef;
    modalRef.show();
  }

  showEditForm(form: ProfileGetDTO) {
    this.form = form;
    this.editMode = true;
    this.title = this.$t("component.profile.update").toString();
    this.uriGenerated = true;
    let modalRef: any = this.$refs.modalRef;
    modalRef.show();
  }

  hideForm() {
    let modalRef: any = this.$refs.modalRef;
    modalRef.hide();
  }

  onValidate() {
    let credentials = [];
    for (let i in this._selectedCredentials) {
      credentials = credentials.concat(this._selectedCredentials[i]);
    }
    this.form.credentials = credentials;

    return new Promise((resolve, reject) => {
      if (this.editMode) {
        this.$emit("onUpdate", this.form, result => {
          if (result instanceof Promise) {
            result.then(resolve).catch(reject);
          } else {
            resolve(result);
          }
        });
      } else {
        return this.$emit("onCreate", this.form, result => {
          if (result instanceof Promise) {
            result.then(resolve).catch(reject);
          } else {
            resolve(result);
          }
        });
      }
    });
  }

  validate() {
    let validatorRef: any = this.$refs.validatorRef;
    validatorRef.validate().then(isValid => {
      if (isValid) {
        if (this.uriGenerated && !this.editMode) {
          this.form.uri = null;
        }

        this.onValidate()
          .then(() => {
            this.$nextTick(() => {
              let modalRef: any = this.$refs.modalRef;
              modalRef.hide();
            });
          })
          .catch(error => {
            if (error.status == 409) {
              console.error("Profile already exists", error);
              this.$opensilex.errorHandler(
                error,
                this.$i18n.t("component.profile.errors.profile-already-exists")
              );
            } else {
              this.$opensilex.errorHandler(error);
            }
          });
      }
    });
  }
}
</script>

<style scoped lang="scss">
</style>

